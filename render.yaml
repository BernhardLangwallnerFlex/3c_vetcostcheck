services:
  # Managed Redis-compatible instance on Render (Key Value / Valkey)
  - type: redis
    name: invoice-redis
    plan: starter
    ipAllowList: []

  # FastAPI web service
  - type: web
    name: invoice-api
    env: docker
    plan: starter
    autoDeploy: true
    healthCheckPath: /healthz
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: invoice-redis
          property: connectionString

      - key: STORAGE_BACKEND
        value: s3
      - key: AWS_DEFAULT_REGION
        value: eu-central-1
      - key: UPLOADS_PREFIX
        value: s3://3c-vetcostcheck/uploads
      - key: OUTPUT_PREFIX
        value: s3://3c-vetcostcheck/processed

      # Secrets: set in Render dashboard (not committed)
      - key: OPENAI_API_KEY
        sync: false
      - key: VISION_AGENT_API_KEY
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: RQ_QUEUE_NAME
        value: invoice-jobs

  # RQ worker
  - type: worker
    name: invoice-worker
    env: docker
    plan: starter
    autoDeploy: true
    dockerCommand: python jobs/worker.py
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: invoice-redis
          property: connectionString

      - key: STORAGE_BACKEND
        value: s3
      - key: AWS_DEFAULT_REGION
        value: eu-central-1
      - key: UPLOADS_PREFIX
        value: s3://3c-vetcostcheck/uploads
      - key: OUTPUT_PREFIX
        value: s3://3c-vetcostcheck/processed
      - key: RQ_QUEUE_NAME
        value: invoice-jobs

      # Same secrets for worker
      - key: OPENAI_API_KEY
        sync: false
      - key: VISION_AGENT_API_KEY
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false